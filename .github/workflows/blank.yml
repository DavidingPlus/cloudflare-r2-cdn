name: Sync Cloudflare R2 to GitHub

on:
  push:
    branches:
      - master  # 触发同步的分支

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install rclone
      run: |
        curl https://rclone.org/install.sh | sudo bash

    - name: Configure rclone for Cloudflare R2
      run: |
        mkdir -p ~/.config/rclone
        echo "[cloudflare_r2]" > ~/.config/rclone/rclone.conf
        echo "type = s3" >> ~/.config/rclone/rclone.conf
        echo "provider = Cloudflare" >> ~/.config/rclone/rclone.conf
        echo "access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}" >> ~/.config/rclone/rclone.conf
        echo "secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}" >> ~/.config/rclone/rclone.conf
        echo "region = us-east-1" >> ~/.config/rclone/rclone.conf
        echo "endpoint = ${{ secrets.R2_ENDPOINT }}" >> ~/.config/rclone/rclone.conf

    - name: Sync data from Cloudflare R2 to GitHub
      run: |
        rclone sync "cloudflare_r2:${{ secrets.R2_BUCKET_NAME }}" ./ --create-empty-src-dirs --progress

        pwd

    - name: Commit and push changes to GitHub
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        git commit -m "Sync Cloudflare R2 data"
        
        pwd
        
        git push
